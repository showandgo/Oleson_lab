---
title: "Calculate Benthic Type by Moku"
output: html_document
date: "2023-03-06"
---

This notebook takes HIMARC Benthic raster data and calculates both the area (extent) of each benthic habitat and proportion of marine moku for each habitat class

```{r setup}
library(raster)
library(rgdal)
library(tidyverse)
library(sf)
library(ggspatial)
```

Import the "raster.df" function to convert cropped raster into df for ease of manipulation

```{r, eval=FALSE}
source("rasterdf.R")
```


```{r}
setwd("C:/Extent Map proj")
data_DIR <- "C:/all_data/remote sensing data"
raster_path <- file.path(data_DIR, "/HIMARC/new data/Benthic_Habitat_5Classes_2022_10.tif")
vector_path <- file.path(data_DIR, "/HIMARC/new data/Moku_marine_wcond.shp")
```


Check .tif info. Note the resolution is (100x100)

```{r}
GDALinfo(raster_path)  
```
Load the HIMARC benthic data and project it to WGS84
Load the Moku marine polygons and project it to WGS84

```{r}
bent <- raster(raster_path)
bent_proj <-  projectRaster(bent, crs = "+proj=longlat +datum=WGS84", method = "ngb")
#plot(bent_proj)

moku_marine <- st_make_valid(st_read(vector_path))
moku_marine <- st_transform(moku_marine, CRS("+proj=longlat +datum=WGS84"))
```

First crop the benthic raster by all of the entire Moku marine extent
Then crop by user specified Moku/ Island.
Note need to change the column name to either "NAME2"/ "ISLAND" respectively when performing crop

```{r}
# Crop by all mokus
cropped <- crop(x = bent_proj, y = extent(moku_marine))

# Crop by particular Moku
mokuname <- "WAIANAE"
island <- "Oahu"

cropped <- (crop(x = bent_proj, y = extent(moku_marine[moku_marine$NAME2 == mokuname,])))
plot(cropped)

marinemoku_crop <- moku_marine[moku_marine$NAME2 == mokuname,]
plot(st_geometry(marinemoku_crop))
```

Code Colour for each benthic habitat class

```{r}
bent_df <- rasterdf(cropped)
bent_codes <- c(1,2,3,4,5)
bent_names <- c("Soft Bottom", "Other Hard Bottom", "Rock/ Boulder", "Pavement", "Coral Dominated Hard Bottom")

clrs <- c("#cccc00", "#4d4d4d", "#cc9900", "#996666", "#99cccc")
names(clrs) <- as.character(bent_codes)
clrs
```
Plot benthic class (by Moku/ Island)

```{r}
p <- ggplot(data = bent_df) +
  geom_raster(aes(x = x, y = y, fill = as.character(value))) +
  geom_sf(data = marinemoku_crop, fill = NA) +
  ggtitle(paste0(mokuname, ",  ", island)) +
  scale_fill_manual(name = "Benthic Habitat",
                    values = clrs,
                    labels = bent_names,
                    na.translate = FALSE) +
  coord_sf(expand = F) +
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(hjust = 0.5)
        ) +
  annotation_north_arrow(height = unit(1, "cm"), 
                         width = unit(.65, "cm"),
                         pad_y = unit(1, "cm")) +
  annotation_scale(location = "bl")
p
```


```{r}
#ggsave(plot = p, filename = "oah6.png")
```

To Calculate the area of each benthic class in each island/ Moku- 
Filter out the N/A and 0 values, group and sum the number pixels in each class (n), 
then multiply by pixel size to get area.

```{r, eval=FALSE}
bent_df <- bent_df %>% filter(bent_df$value > 0)
agg_bent<- bent_df %>% 
  count(value) %>% 
  mutate('area m^2' = n * 100 * 100,
         'area km^2' = round((n * 100 * 100)/ 1e6, 2))

agg_bent$Benthic_type <- agg_bent$value  
agg_bent$Benthic_type[agg_bent$value == 1] <- "Soft Bottom"
agg_bent$Benthic_type[agg_bent$value == 2] <- "Other Hard Bottom"
agg_bent$Benthic_type[agg_bent$value == 3] <- "Rock/ Boulder"
agg_bent$Benthic_type[agg_bent$value == 4] <- "Pavement"
agg_bent$Benthic_type[agg_bent$value == 5] <- "Coral Denominated Hard Bottom"

agg_bent$Moku <- mokuname
agg_bent$Island <- island

```

Calculate Area of Moku

```{r}
#Area of Moku(s) 
moku_area <- sum(st_area(marinemoku_crop[marinemoku_crop$NAME2 == mokuname,]))
```

Check the area as % of Moku area

```{r}
sum(agg_bent$`area m^2`) / moku_area
```
Append a column with the % of moarine moku area that is covered by each Benthic type/ class

```{r}
agg_bent$prop_cover <- agg_bent$`area m^2` / moku_area
```


Get all Moku names or island

```{r}
island <- "Oahu"

list(moku_marine$NAME2[moku_marine$ISLAND == island])

mokus <- list("KOOLAULOA" , "WAIALUA"  ,  "WAIANAE" ,   "EWA"   ,   "KOOLAUPOKO", "KONA OAH")

```


Function to combine in one df all the Benthic type/ class (by Moku)  for one island 

```{r}

df <- data.frame()

make_df <- function(mokus, island){
  
  
  for (i in mokus){
    
    cropped <- (crop(x = bent_proj, y = extent(moku_marine[moku_marine$NAME2 == i,])))
    marinemoku_crop <- moku_marine[moku_marine$NAME2 == i,]
    moku_area <- sum(st_area(marinemoku_crop[marinemoku_crop$NAME2 == i,]))
    
    
    bent_df <- rasterdf(cropped)
    bent_df <- bent_df %>% filter(bent_df$value > 0)
    
    agg_bent<- bent_df %>% 
      count(value) %>% 
      mutate('area m^2' = n * 100 * 100,
         'area km^2' = round((n * 100 * 100)/ 1e6, 2)) %>% 
      mutate('prop_cover' = `area m^2` / moku_area)
    
    agg_bent$Benthic_type <- agg_bent$value  
    agg_bent$Benthic_type[agg_bent$value == 1] <- "Soft Bottom"
    agg_bent$Benthic_type[agg_bent$value == 2] <- "Other Hard Bottom"
    agg_bent$Benthic_type[agg_bent$value == 3] <- "Rock/ Boulder"
    agg_bent$Benthic_type[agg_bent$value == 4] <- "Pavement"
    agg_bent$Benthic_type[agg_bent$value == 5] <- "Coral Denominated Hard Bottom"
    agg_bent$Moku <- i
    agg_bent$Island <- island
    
    df <- rbind(df, agg_bent)

  }
    
    
}
```

```{r}
make_df(mokus, island)

df
```

